const std = @import("std");
const common = @import("common");
const zigxParser = @import("zigxParser");

const Writer = common.Writer;

pub fn generate(allocator: std.mem.Allocator, output_path: []const u8, documents: []const zigxParser.ZigxDocument) !void {
    var out_file = try std.fs.cwd().createFile(output_path, .{});
    defer out_file.close();

    var buf: [8192]u8 = undefined;
    var writer = out_file.writer(&buf);
    const w = &writer.interface;

    try writeHeader(w);
    try writeImports(w, documents);
    try writeRegisterFunction(w, documents);
    try writer.interface.flush();

    _ = allocator;
}

fn writeHeader(w: *Writer) !void {
    try w.writeAll(
        \\// Auto-generated file - DO NOT EDIT
        \\// Generated by build/gen_zigx.zig
        \\
        \\const std = @import("std");
        \\const app_mod = @import("../Framework/Http/Server/app.zig");
        \\const App = app_mod.App;
        \\
        \\// Import server handlers
        \\
    );
}

fn writeImports(w: *Writer, documents: []const zigxParser.ZigxDocument) !void {
    for (documents) |doc| {
        try w.print(
            \\const {s}_server = @import("server/{s}.zig");
            \\
        , .{ doc.file_name, doc.file_name });
    }
}

fn writeRegisterFunction(w: *Writer, documents: []const zigxParser.ZigxDocument) !void {
    try w.writeAll(
        \\
        \\pub fn registerRoutes(allocator: std.mem.Allocator, app: *App) void {
        \\
    );

    // Register page handlers
    for (documents) |doc| {
        try w.print(
            \\    app.get(allocator, "{s}", {s}_server.handler);
            \\
        , .{ doc.route, doc.file_name });
    }

    try w.writeAll(
        \\
        \\    // Register custom API routes if defined
        \\
    );

    // Call routes(app) if defined in each server module
    for (documents) |doc| {
        try w.print(
            \\    if (@hasDecl({s}_server, "routes")) {{
            \\        {s}_server.routes(allocator, app);
            \\    }}
            \\
        , .{ doc.file_name, doc.file_name });
    }

    try w.writeAll(
        \\}
        \\
    );
}
